<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TikTok Live Blind Box Experiment</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background: #fafafa;
      margin: 0;
      padding: 0;
    }

    h1 {
      font-size: 1.8em;
      margin-top: 20px;
      font-weight: 700;
    }

    .hidden { display: none; }

    .btn {
      display: inline-block;
      margin: 8px;
      padding: 12px 20px;
      border: none;
      border-radius: 10px;
      background: #333;
      color: white;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      transition: 0.3s;
    }

    .btn:hover { background: #555; }

    .btn.disabled {
      background: #ccc;
      color: #666;
      cursor: not-allowed;
      opacity: 0.6;
    }

    /* ✅ Pink buy button override */
    #buy-btn {
      margin-top: 20px;
      background: #ff3b5c;
      color: #fff;
      font-weight: 600;
      box-shadow: 0 4px 10px rgba(255, 59, 92, 0.3);
      transition: all 0.3s ease;
    }

    #buy-btn:hover {
      background: #e03552;
      box-shadow: 0 6px 12px rgba(255, 59, 92, 0.4);
      transform: scale(1.05);
    }

    iframe {
      width: 90%;
      max-width: 360px;
      height: 640px;
      border: none;
      border-radius: 14px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      background: black;
      pointer-events: none; /* disables user controls like seeking */
    }

    .video-container {
      display: flex;
      justify-content: center;
      margin-top: 20px;
    }

    @media (max-width: 600px) {
      h1 { font-size: 1.4em; }
      .btn { font-size: 14px; padding: 10px 16px; }
      iframe { width: 95%; height: 70vh; }
    }
  </style>
</head>

<body>
  <h1>TikTok Live Blind Box Experiment</h1>

  <!-- Participant Info Form -->
  <div id="introForm">
    <h3>Before we begin, please enter your details:</h3>

    <label>Age: </label>
    <input type="number" id="ageInput" min="15" max="40" required><br><br>

    <label>Sex (F/M): </label>
    <label><input type="radio" name="sex" value="M"> Male</label>
    <label><input type="radio" name="sex" value="F"> Female</label><br><br>

    <label>Year Level:</label>
    <select id="yearInput" required>
      <option value="">Select Year Level</option>
      <option value="Freshman">Freshman</option>
      <option value="Sophomore">Sophomore</option>
      <option value="Junior">Junior</option>
      <option value="Senior">Senior</option>
    </select><br><br>

    <button class="btn" onclick="startExperiment()">Continue</button>
  </div>

  <!-- Experiment Section -->
  <div id="experimentSection" class="hidden">
    <p>Select a video to start:</p>
    <div id="videoButtons">
      <button class="btn" onclick="loadVideo(1)">1st Video</button>
      <button class="btn" onclick="loadVideo(2)">2nd Video</button>
      <button class="btn" onclick="loadVideo(3)">3rd Video</button>
      <button class="btn" onclick="loadVideo(4)">4th Video</button>
    </div>

    <div class="video-container" id="videoContainer"></div>

    <div>
      <button id="buy-btn" class="btn hidden" onclick="purchase()">Buy Blind Box (₱600)</button>
    </div>

    <p id="credits"></p>
    <p id="purchases"></p>
  </div>

  <script>
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxDfqRhhO4G2wHnZ_n6CaIgrKk0CmwSVCO-kPjk4a6JZnJFThBeRShM7HrdqAA4B5hDXg/exec";

    const VIDEOS = {
      1: "https://drive.google.com/file/d/1GLtIo84CfXQZDiM9W4bmlW5lU02eZTvp/preview", // No cues
      2: "https://drive.google.com/file/d/1hOdxkf0gm4uSimeR-TYAyeLoSp94WHvb/preview", // Scarcity cue
      3: "https://drive.google.com/file/d/1tuyGujJ0ITGpQMXEm22tyLsX4UecQ_pK/preview", // Social proof cue
      4: "https://drive.google.com/file/d/1503oZfL8kZoI8o1OHBO2WV5kVPC3oW-l/preview"  // Both cues
    };

    const STARTING_CREDITS = 3000;
    const BOX_PRICE = 600;

    let participantID, currentVideo, credits, totalPurchased, videoStartTime, age, sex, yearLevel;

    function generatePID() {
      const now = new Date();
      return "P" + now.getFullYear() +
        (now.getMonth()+1).toString().padStart(2,'0') +
        now.getDate().toString().padStart(2,'0') + "_" +
        now.getHours().toString().padStart(2,'0') +
        now.getMinutes().toString().padStart(2,'0') +
        now.getSeconds().toString().padStart(2,'0') + "_" +
        Math.floor(Math.random()*1000);
    }

    function startExperiment() {
      age = document.getElementById("ageInput").value.trim();
      const sexRadios = document.getElementsByName("sex");
      const selected = [...sexRadios].find(r => r.checked);
      sex = selected ? selected.value : "";
      yearLevel = document.getElementById("yearInput").value;

      if (!age || !sex || !yearLevel) {
        alert("Please enter Age, Sex, and Year Level before continuing.");
        return;
      }

      document.getElementById("introForm").classList.add("hidden");
      document.getElementById("experimentSection").classList.remove("hidden");

      participantID = generatePID();
      logEvent("FORM_SUBMIT", 0, 0, 0);
    }

    function loadVideo(num) {
      currentVideo = {number: num, file: VIDEOS[num]};
      document.querySelectorAll('#videoButtons .btn').forEach(btn => {
        btn.classList.add('disabled');
        btn.disabled = true;
      });

      const container = document.getElementById("videoContainer");
      container.innerHTML = `<iframe src="${currentVideo.file}?autoplay=1&modestbranding=1" allow="autoplay; encrypted-media" allowfullscreen></iframe>`;
      document.getElementById("buy-btn").classList.remove("hidden");

      credits = STARTING_CREDITS;
      totalPurchased = 0;
      videoStartTime = new Date();
      updateStatus();

      logEvent("VIDEO_LOAD", 0, 0, 0);
    }

    function purchase() {
      let elapsed = (new Date() - videoStartTime) / 1000;
      let playbackTime = elapsed; // Approximation since iframe can't give exact time

      if (credits >= BOX_PRICE) {
        credits -= BOX_PRICE;
        totalPurchased++;
        updateStatus();
        logEvent("BUY", totalPurchased, elapsed, playbackTime);
      } else {
        alert("Not enough credits!");
      }
    }

    function updateStatus() {
      document.getElementById("credits").innerText = "Credits Remaining: ₱" + credits;
      document.getElementById("purchases").innerText = "Blind Boxes Purchased: " + totalPurchased;
    }

    function logEvent(action, purchases, elapsedTime, playbackTime) {
      const payload = {
        timestamp: new Date().toISOString(),
        pid: participantID || "N/A",
        age: age || "N/A",
        sex: sex || "N/A",
        yearLevel: yearLevel || "N/A",
        videoNumber: currentVideo ? currentVideo.number : "",
        videoFile: currentVideo ? currentVideo.file : "",
        action: action,
        creditsRemaining: credits,
        totalPurchased: purchases,
        timeSinceStart: elapsedTime,
        videoPlaybackTime: playbackTime
      };

      const body = "data=" + encodeURIComponent(JSON.stringify(payload));
      fetch(GOOGLE_SCRIPT_URL, {
        method: "POST",
        headers: {"Content-Type": "application/x-www-form-urlencoded;charset=UTF-8"},
        body
      })
      .then(r => r.text())
      .then(txt => console.log("Sheets response:", txt))
      .catch(err => console.error("Logging error", err));
    }
  </script>
</body>
</html>
