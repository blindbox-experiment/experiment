<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TikTok Live Blind Box Experiment</title>
  <style>
    :root{
      --max-width: 420px;
      --gap: 12px;
      --btn-size: 16px;
      --pink: #ff3b5c;
      --pink-dark: #e03552;
    }
    html,body{ height:100%; margin:0; }
    body {
      font-family: Arial, Helvetica, sans-serif;
      text-align: center;
      background: #fafafa;
      color: #111;
      padding: 16px;
      -webkit-tap-highlight-color: transparent;
      -webkit-font-smoothing:antialiased;
    }

    h1{ font-size:1.25rem; margin:0 0 10px; }
    p{ margin:8px 0; font-size:0.95rem; }

    .hidden { display: none !important; }

    /* Buttons - touch-friendly */
    .btn {
      display: inline-block;
      margin: var(--gap) 6px;
      padding: 14px 18px;
      border: none;
      border-radius: 10px;
      background: #232323;
      color: white;
      cursor: pointer;
      font-size: var(--btn-size);
      line-height:1;
      min-width: 120px;
      box-shadow: 0 6px 12px rgba(0,0,0,0.08);
      touch-action: manipulation;
    }
    .btn:active { transform: translateY(1px); }
    .btn.large { padding: 16px 22px; min-width: 140px; font-size: 18px; }
    .btn.disabled { background:#ccc; color:#666; cursor:not-allowed; opacity:0.8; }

    /* BUY button (changed to pink) */
    #buy-btn{
      background: var(--pink);
      color: white;
      border-radius: 12px;
      padding: 12px 22px;
      font-weight: 700;
      box-shadow: 0 8px 20px rgba(255,59,92,0.18);
      border: 0;
    }
    #buy-btn:hover { background: var(--pink-dark); }

    label { font-size:0.95rem; }
    input[type="number"]{ padding:8px; border-radius:8px; border:1px solid #ddd; width:120px; font-size:1rem; margin-top:6px; }
    select { padding:8px; border-radius:8px; border:1px solid #ddd; font-size:1rem; margin-top:6px; }

    /* Responsive video container maintaining 9:16 aspect ratio */
    .video-wrapper {
      width: min(var(--max-width), 94vw);
      margin: 14px auto 8px;
    }
    .video-frame {
      position: relative;
      width: 100%;
      /* 9:16 ratio -> padding-top = 16/9 * 100% = 177.78% */
      padding-top: 177.78%;
      background:#000;
      border-radius:14px;
      overflow:hidden;
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
    }
    /* iframe or video full cover */
    .video-frame iframe,
    .video-frame video {
      position: absolute;
      left:0; top:0; width:100%; height:100%;
      border:0;
      display:block;
    }

    /* form & layout tweaks for small screens */
    .form-row { margin:10px 0; display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap; }
    .small-note { font-size:0.82rem; color:#555; margin-top:6px; }

    /* status text */
    #credits,#purchases { margin-top:10px; font-weight:600; }

    @media (min-width:600px){
      h1{ font-size:1.5rem; }
      :root{ --max-width: 360px; --btn-size:16px; }
    }
  </style>
</head>
<body>
  <h1>TikTok Live Blind Box Experiment</h1>

  <!-- Participant Info Form -->
  <div id="introForm">
    <h3>Before we begin, please enter your details:</h3>

    <div class="form-row">
      <label for="ageInput">Age:</label>
      <input type="number" id="ageInput" min="15" max="40" placeholder="e.g. 20" />
    </div>

    <div class="form-row" style="justify-content:center;">
      <label>Sex (F/M):</label>
      <label style="margin-left:8px;"><input type="radio" name="sex" value="M"> Male</label>
      <label style="margin-left:8px;"><input type="radio" name="sex" value="F"> Female</label>
    </div>

    <div class="form-row">
      <label for="yearInput">Year Level:</label>
      <select id="yearInput">
        <option value="">Select Year Level</option>
        <option value="Freshman">Freshman</option>
        <option value="Sophomore">Sophomore</option>
        <option value="Junior">Junior</option>
        <option value="Senior">Senior</option>
      </select>
    </div>

    <div style="margin-top:10px;">
      <button class="btn large" onclick="startExperiment()">Continue</button>
    </div>
    <div class="small-note">Use a phone or tablet in portrait orientation for the intended experience.</div>
  </div>

  <!-- Experiment Section -->
  <div id="experimentSection" class="hidden">
    <p>Select a video to start:</p>
    <div id="videoButtons" style="display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin-bottom:10px;">
      <button class="btn" onclick="loadVideo(1)">1st Video</button>
      <button class="btn" onclick="loadVideo(2)">2nd Video</button>
      <button class="btn" onclick="loadVideo(3)">3rd Video</button>
      <button class="btn" onclick="loadVideo(4)">4th Video</button>
    </div>

    <div class="video-wrapper">
      <div class="video-frame" id="videoFrame">
        <!-- iframe or video inserted here dynamically -->
      </div>
    </div>

    <div>
      <button id="buy-btn" class="btn large hidden" onclick="purchase()">Buy Blind Box (₱600)</button>
    </div>

    <p id="credits"></p>
    <p id="purchases"></p>
  </div>

  <script>
    // === CONFIG - keep your Google Script URL here ===
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxDfqRhhO4G2wHnZ_n6CaIgrKk0CmwSVCO-kPjk4a6JZnJFThBeRShM7HrdqAA4B5hDXg/exec";

    // If you're using Google Drive preview links use /preview ; if using direct MP4 URLs point them here instead.
    const VIDEOS = {
      1: "https://drive.google.com/file/d/1GLtIo84CfXQZDiM9W4bmlW5lU02eZTvp/preview", // No cues
      2: "https://drive.google.com/file/d/1hOdxkf0gm4uSimeR-TYAyeLoSp94WHvb/preview", // Scarcity cue
      3: "https://drive.google.com/file/d/1tuyGujJ0ITGpQMXEm22tyLsX4UecQ_pK/preview", // Social proof cue
      4: "https://drive.google.com/file/d/1503oZfL8kZoI8o1OHBO2WV5kVPC3oW-l/preview"  // Both cues
    };

    const STARTING_CREDITS = 3000;
    const BOX_PRICE = 600;

    let participantID = null, currentVideo = null, credits = STARTING_CREDITS, totalPurchased = 0, videoStartTime = null, age = "", sex = "", yearLevel = "";

    // Generate unique PID
    function generatePID(){
      const now = new Date();
      return "P" + now.getFullYear() +
        (now.getMonth()+1).toString().padStart(2,'0') +
        now.getDate().toString().padStart(2,'0') + "_" +
        now.getHours().toString().padStart(2,'0') +
        now.getMinutes().toString().padStart(2,'0') +
        now.getSeconds().toString().padStart(2,'0') + "_" +
        Math.floor(Math.random()*1000);
    }

    function startExperiment(){
      age = (document.getElementById("ageInput").value || "").toString().trim();
      const sexRadios = document.getElementsByName("sex");
      const sel = [...sexRadios].find(r => r.checked);
      sex = sel ? sel.value : "";
      yearLevel = document.getElementById("yearInput").value || "";

      if(!age || !sex || !yearLevel){
        alert("Please enter Age, Sex, and Year Level before continuing.");
        return;
      }

      document.getElementById("introForm").classList.add("hidden");
      document.getElementById("experimentSection").classList.remove("hidden");

      participantID = generatePID();
      credits = STARTING_CREDITS;
      totalPurchased = 0;
      updateStatus();

      logEvent("FORM_SUBMIT", 0, 0, 0);
      // ensure buy button hidden until they pick a video
      document.getElementById("buy-btn").classList.add("hidden");
    }

    // Load video (inject iframe or <video> depending on link)
    function loadVideo(num){
      currentVideo = { number: num, file: VIDEOS[num] };

      // disable buttons so they can't switch condition
      document.querySelectorAll('#videoButtons .btn').forEach(b => { b.classList.add('disabled'); b.disabled=true; });

      const frame = document.getElementById("videoFrame");
      frame.innerHTML = ""; // clear

      // If VIDEO string looks like a direct mp4 file (.mp4 or ?raw=1), use native video element (better mobile control).
      const url = currentVideo.file;
      const isDirectMp4 = url.match(/\.mp4(\?|$)/i) || url.includes("?raw=1");

      if(isDirectMp4){
        const v = document.createElement("video");
        v.setAttribute("playsinline",""); // mobile inline playback
        v.setAttribute("webkit-playsinline",""); 
        v.setAttribute("muted",""); // muted may allow autoplay on mobile
        v.setAttribute("preload","metadata");
        v.controls = true; // native controls on mobile are usually fine
        v.src = url;
        frame.appendChild(v);

        // set start time and logging
        videoStartTime = null;
        v.addEventListener("play", () => {
          if(!videoStartTime){ videoStartTime = new Date(); logEvent("VIDEO_PLAY",0,0,0); }
        });
      } else {
        // fallback: embed iframe (Google Drive preview). Some mobile behaviors vary.
        const ifr = document.createElement("iframe");
        ifr.src = url;
        ifr.allow = "autoplay; encrypted-media; fullscreen";
        ifr.allowFullscreen = true;
        frame.appendChild(ifr);

        // we can't access iframe playback time reliably; approximate start time
        videoStartTime = new Date();
      }

      // show buy button now that a video is selected
      document.getElementById("buy-btn").classList.remove("hidden");

      credits = STARTING_CREDITS;
      totalPurchased = 0;
      updateStatus();

      logEvent("VIDEO_LOAD",0,0,0);
    }

    function purchase(){
      // estimate elapsed since video start (approx for iframe)
      let elapsed = 0;
      if(videoStartTime) elapsed = (new Date() - videoStartTime)/1000;

      // For iframe we cannot get exact playback time; use elapsed as approximation
      let playbackTime = elapsed;

      if(credits >= BOX_PRICE){
        credits -= BOX_PRICE;
        totalPurchased++;
        updateStatus();
        logEvent("BUY", totalPurchased, elapsed, playbackTime);
      } else {
        alert("Not enough credits!");
      }
    }

    function updateStatus(){
      document.getElementById("credits").innerText = "Credits Remaining: ₱" + credits;
      document.getElementById("purchases").innerText = "Blind Boxes Purchased: " + totalPurchased;
    }

    function logEvent(action, purchases, elapsedTime, playbackTime){
      const payload = {
        timestamp: new Date().toISOString(),
        pid: participantID || "N/A",
        age: age || "N/A",
        sex: sex || "N/A",
        yearLevel: yearLevel || "N/A",
        videoNumber: currentVideo ? currentVideo.number : "",
        videoFile: currentVideo ? currentVideo.file : "",
        action,
        creditsRemaining: credits,
        totalPurchased: purchases,
        timeSinceStart: elapsedTime,
        videoPlaybackTime: playbackTime
      };

      const body = "data=" + encodeURIComponent(JSON.stringify(payload));
      fetch(GOOGLE_SCRIPT_URL, {
        method: "POST",
        headers: {"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},
        body
      })
      .then(r => r.text())
      .then(txt => console.log("Sheets response:", txt))
      .catch(err => console.error("Logging error", err));
    }
  </script>
</body>
</html>
