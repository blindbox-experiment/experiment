<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TikTok Live Blind Box Experiment</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background: #fafafa;
    }
    .video-container {
      display: flex;
      justify-content: center;
      margin-top: 20px;
    }
    video {
      width: 360px;
      height: 640px; /* TikTok 9:16 vertical format */
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      background: black;
    }
    .btn {
      display: inline-block;
      margin: 10px;
      padding: 12px 20px;
      border: none;
      border-radius: 6px;
      background: #333;
      color: white;
      cursor: pointer;
      font-size: 16px;
      transition: opacity 0.3s;
    }
    .btn:hover { background: #555; }
    .btn.disabled {
      background: #ccc;
      color: #666;
      cursor: not-allowed;
      opacity: 0.6;
    }
    #buy-btn {
      margin-top: 20px;
      background: #ff3b5c;
    }
  </style>
</head>
<body>
  <h1>TikTok Live Blind Box Experiment</h1>
  <p>Select a video to start:</p>
  
  <!-- Video condition buttons -->
  <div id="videoButtons">
    <button class="btn" onclick="loadVideo(1)">1st Video</button>
    <button class="btn" onclick="loadVideo(2)">2nd Video</button>
    <button class="btn" onclick="loadVideo(3)">3rd Video</button>
    <button class="btn" onclick="loadVideo(4)">4th Video</button>
  </div>
  
  <!-- Where video will load -->
  <div class="video-container">
    <video id="expVideo" controls playsinline></video>
  </div>

  <!-- Buy button -->
  <div>
    <button id="buy-btn" class="btn" onclick="purchase()" style="display:none;">Buy Blind Box (₱600)</button>
  </div>

  <p id="credits"></p>
  <p id="purchases"></p>

  <script>
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwC2yuFCyEDXeu9VG03cb9RVrazcg2vLCZzneElUFPyI2EobE13KnlRT7ZLmrojLHdwIg/exec"; 
    const VIDEOS = {
      1: "videos/video1.mp4",
      2: "videos/video2.mp4",
      3: "videos/video3.mp4",
      4: "videos/video4.mp4"
    };
    const STARTING_CREDITS = 3000;
    const BOX_PRICE = 600;

    let participantID = null;
    let currentVideo = null;
    let credits = STARTING_CREDITS;
    let totalPurchased = 0;
    let videoStartTime = null;

    function generatePID() {
      const now = new Date();
      return "P" + now.getFullYear() + 
        (now.getMonth()+1).toString().padStart(2,'0') + 
        now.getDate().toString().padStart(2,'0') + "_" + 
        now.getHours().toString().padStart(2,'0') + 
        now.getMinutes().toString().padStart(2,'0') + 
        now.getSeconds().toString().padStart(2,'0') + "_" + 
        Math.floor(Math.random()*1000);
    }

    function loadVideo(num) {
      participantID = generatePID();
      currentVideo = {number: num, file: VIDEOS[num]};

      const buttons = document.querySelectorAll('#videoButtons .btn');
      buttons.forEach(btn => {
        btn.classList.add('disabled');
        btn.disabled = true;
      });

      const videoEl = document.getElementById("expVideo");
      videoEl.src = currentVideo.file;
      document.getElementById("buy-btn").style.display = "inline-block";

      credits = STARTING_CREDITS;
      totalPurchased = 0;
      updateStatus();

      logEvent("PAGE_LOAD", 0, 0);

      videoEl.addEventListener("play", () => {
        if (!videoStartTime) {
          videoStartTime = new Date();
          logEvent("VIDEO_PLAY", 0, 0);
        }
      });
    }

    function purchase() {
      if (credits >= BOX_PRICE) {
        credits -= BOX_PRICE;
        totalPurchased++;
        updateStatus();

        let elapsed = 0;
        if (videoStartTime) {
          elapsed = (new Date() - videoStartTime) / 1000;
        }

        logEvent("BUY", totalPurchased, elapsed);
      } else {
        alert("Not enough credits!");
      }
    }

    function updateStatus() {
      document.getElementById("credits").innerText = 
        "Credits Remaining: ₱" + credits;
      document.getElementById("purchases").innerText = 
        "Blind Boxes Purchased: " + totalPurchased;
    }

    function logEvent(action, purchases, elapsedTime) {
      const payload = {
        timestamp: new Date().toISOString(),
        pid: participantID,
        videoNumber: currentVideo ? currentVideo.number : "",
        videoFile: currentVideo ? currentVideo.file : "",
        action: action,
        creditsRemaining: credits,
        totalPurchased: purchases,
        timeSinceStart: elapsedTime
      };

      fetch(GOOGLE_SCRIPT_URL, {
        method: "POST",
        body: JSON.stringify(payload),
        headers: {"Content-Type": "application/json"}
      }).catch(err => console.error("Logging error", err));
    }
  </script>
</body>
</html>
