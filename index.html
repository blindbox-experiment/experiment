<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TikTok Live Blind Box Experiment</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background: #fafafa;
    }
    .hidden { display: none; }
    .btn {
      display: inline-block;
      margin: 10px;
      padding: 12px 20px;
      border: none;
      border-radius: 6px;
      background: #333;
      color: white;
      cursor: pointer;
      font-size: 16px;
      transition: opacity 0.3s;
    }
    .btn:hover { background: #555; }
    .btn.disabled {
      background: #ccc;
      color: #666;
      cursor: not-allowed;
      opacity: 0.6;
    }
    video {
      width: 360px;
      height: 640px; /* TikTok 9:16 format */
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      background: black;
    }
    #buy-btn { margin-top: 20px; background: #ff3b5c; }
    .video-container { display: flex; justify-content: center; margin-top: 20px; }
  </style>
</head>
<body>
  <h1>TikTok Live Blind Box Experiment</h1>

  <!-- Participant Info Form -->
  <div id="introForm">
    <h3>Before we begin, please enter your details:</h3>

    <label>Age: </label>
    <input type="number" id="ageInput" min="15" max="40" required><br><br>

    <label>Sex (F/M): </label>
    <label><input type="radio" name="sex" value="M"> Male</label>
    <label><input type="radio" name="sex" value="F"> Female</label><br><br>

    <label>Year Level:</label>
    <select id="yearInput" required>
      <option value="">Select Year Level</option>
      <option value="Freshman">Freshman</option>
      <option value="Sophomore">Sophomore</option>
      <option value="Junior">Junior</option>
      <option value="Senior">Senior</option>
    </select><br><br>

    <button class="btn" onclick="startExperiment()">Continue</button>
  </div>

  <!-- Experiment Section -->
  <div id="experimentSection" class="hidden">
    <p>Select a video to start:</p>
    <div id="videoButtons">
      <button class="btn" onclick="loadVideo(1)">1st Video</button>
      <button class="btn" onclick="loadVideo(2)">2nd Video</button>
      <button class="btn" onclick="loadVideo(3)">3rd Video</button>
      <button class="btn" onclick="loadVideo(4)">4th Video</button>
    </div>

    <div class="video-container">
      <video id="expVideo" controls playsinline></video>
    </div>

    <div>
      <button id="buy-btn" class="btn hidden" onclick="purchase()">Buy Blind Box (₱600)</button>
    </div>

    <p id="credits"></p>
    <p id="purchases"></p>
  </div>

  <script>
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwnyZZmN5bVTRot73lL-IBtaewbws6Ip5AvdZvEXzYdxRFw-HEDUbB0jqGA0iDHN755vQ/exec";

    const VIDEOS = {
      1: "videos/video1.mp4",
      2: "videos/video2.mp4",
      3: "videos/video3.mp4",
      4: "videos/video4.mp4"
    };
    const STARTING_CREDITS = 3000;
    const BOX_PRICE = 600;

    let participantID, currentVideo, credits, totalPurchased, videoStartTime, age, sex, yearLevel;

    function generatePID() {
      const now = new Date();
      return "P" + now.getFullYear() + 
        (now.getMonth()+1).toString().padStart(2,'0') + 
        now.getDate().toString().padStart(2,'0') + "_" + 
        now.getHours().toString().padStart(2,'0') + 
        now.getMinutes().toString().padStart(2,'0') + 
        now.getSeconds().toString().padStart(2,'0') + "_" + 
        Math.floor(Math.random()*1000);
    }

    function startExperiment() {
      age = document.getElementById("ageInput").value.trim();
      const sexRadios = document.getElementsByName("sex");
      const selected = [...sexRadios].find(r => r.checked);
      sex = selected ? selected.value : "";
      yearLevel = document.getElementById("yearInput").value;

      if (!age || !sex || !yearLevel) {
        alert("Please enter Age, Sex, and Year Level before continuing.");
        return;
      }

      document.getElementById("introForm").classList.add("hidden");
      document.getElementById("experimentSection").classList.remove("hidden");

      participantID = generatePID();
      logEvent("FORM_SUBMIT", 0, 0, 0);
    }

    function loadVideo(num) {
      currentVideo = {number: num, file: VIDEOS[num]};
      document.querySelectorAll('#videoButtons .btn').forEach(btn => {
        btn.classList.add('disabled');
        btn.disabled = true;
      });

      const videoEl = document.getElementById("expVideo");
      videoEl.src = currentVideo.file;
      document.getElementById("buy-btn").classList.remove("hidden");

      credits = STARTING_CREDITS;
      totalPurchased = 0;
      videoStartTime = null;
      updateStatus();

      logEvent("VIDEO_LOAD", 0, 0, 0);

      videoEl.addEventListener("play", () => {
        if (!videoStartTime) {
          videoStartTime = new Date();
          logEvent("VIDEO_PLAY", 0, 0, 0);
        }
      });
    }

    function purchase() {
      const videoEl = document.getElementById("expVideo");
      const playbackTime = videoEl.currentTime;

      if (credits >= BOX_PRICE) {
        credits -= BOX_PRICE;
        totalPurchased++;
        updateStatus();

        let elapsed = 0;
        if (videoStartTime) elapsed = (new Date() - videoStartTime) / 1000;
        logEvent("BUY", totalPurchased, elapsed, playbackTime);
      } else {
        alert("Not enough credits!");
      }
    }

    function updateStatus() {
      document.getElementById("credits").innerText = "Credits Remaining: ₱" + credits;
      document.getElementById("purchases").innerText = "Blind Boxes Purchased: " + totalPurchased;
    }

    function logEvent(action, purchases, elapsedTime, playbackTime) {
      const payload = {
        timestamp: new Date().toISOString(),
        pid: participantID || "N/A",
        age: age || "N/A",
        sex: sex || "N/A",
        yearLevel: yearLevel || "N/A",
        videoNumber: currentVideo ? currentVideo.number : "",
        videoFile: currentVideo ? currentVideo.file : "",
        action: action,
        creditsRemaining: credits,
        totalPurchased: purchases,
        timeSinceStart: elapsedTime,
        videoPlaybackTime: playbackTime
      };

      const body = "data=" + encodeURIComponent(JSON.stringify(payload));
      fetch(GOOGLE_SCRIPT_URL, {
        method: "POST",
        headers: {"Content-Type": "application/x-www-form-urlencoded;charset=UTF-8"},
        body
      })
      .then(r => r.text())
      .then(txt => console.log("Sheets response:", txt))
      .catch(err => console.error("Logging error", err));
    }
  </script>
</body>
</html>
