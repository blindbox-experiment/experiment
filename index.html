<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>TikTok Live Blind Box Experiment — Manual play + scrubbing</title>
<style>
  :root{--pink:#ff3b5c;--bg:#fafafa;}
  body{font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);margin:0;padding:20px;text-align:center;color:#111;}
  h1{margin:6px 0 12px;font-size:22px;}
  .row{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin:10px 0}
  .btn{padding:10px 18px;border-radius:10px;border:0;background:#333;color:#fff;cursor:pointer;font-weight:600}
  .btn.small{padding:8px 12px}
  .btn.disabled{background:#ddd;color:#999;cursor:not-allowed}
  #buy-btn{background:var(--pink);color:#fff;border-radius:12px;padding:12px 22px;border:0;font-weight:700;box-shadow:0 8px 20px rgba(255,59,92,0.18)}
  .video-wrap{max-width:420px;margin:20px auto}
  video{width:100%;border-radius:12px;background:#000;display:block}
  .status{margin-top:12px;font-weight:600}
  label{margin-right:8px}
  input[type=number]{width:84px;padding:6px;border-radius:6px;border:1px solid #ddd}
  select{padding:6px;border-radius:6px;border:1px solid #ddd}
  @media(max-width:480px){
    .video-wrap{max-width:92vw}
    h1{font-size:18px}
  }
</style>
</head>
<body>
  <h1>TikTok Live Blind Box Experiment</h1>

  <!-- participant form -->
  <div id="intro">
    <div style="margin-bottom:8px">
      <label>Age:</label><input id="ageInput" type="number" min="15" max="40">
    </div>
    <div style="margin-bottom:8px">
      <label>Sex (F/M):</label>
      <label><input type="radio" name="sex" value="M"> M</label>
      <label><input type="radio" name="sex" value="F"> F</label>
    </div>
    <div style="margin-bottom:12px">
      <label>Year level:</label>
      <select id="yearInput"><option value="">Select</option><option>Freshman</option><option>Sophomore</option><option>Junior</option><option>Senior</option></select>
    </div>
    <button class="btn" onclick="startExperiment()">Continue</button>
  </div>

  <!-- experiment -->
  <div id="experiment" style="display:none">
    <p>Select a video to start:</p>
    <div class="row" id="videoButtons">
      <button class="btn small" id="b1" onclick="loadVideo(1)">1st Video</button>
      <button class="btn small" id="b2" onclick="loadVideo(2)">2nd Video</button>
      <button class="btn small" id="b3" onclick="loadVideo(3)">3rd Video</button>
      <button class="btn small" id="b4" onclick="loadVideo(4)">4th Video</button>
    </div>

    <div class="video-wrap">
      <video id="expVideo" controls playsinline preload="metadata"></video>
    </div>

    <div>
      <button id="buy-btn" style="display:none" onclick="purchase()">Buy Blind Box (₱600)</button>
    </div>

    <div class="status" id="status">Credits Remaining: ₱0 · Blind Boxes Purchased: 0</div>
  </div>

<script>
/* ====== CONFIG - edit only IDs / URLs if needed ====== */
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxDfqRhhO4G2wHnZ_n6CaIgrKk0CmwSVCO-kPjk4a6JZnJFThBeRShM7HrdqAA4B5hDXg/exec";

/* NEW Drive IDs (you gave these earlier) */
const DRIVE_IDS = {
  1: "1r6tXOccwsWd0UmhMWMH9H5bCUdjprucy",
  2: "1Oj7kbstiuW9azTy1n93c-tN_7LpmmXmd",
  3: "1qvO5WOyskRm2g2F0o8n0DnjZCDtBEqIW",
  4: "157K9XHgY_PGPFz0v4ldX1QFmEAYNaCWg"
};

function driveDirect(id){ return `https://docs.google.com/uc?export=download&id=${id}`; }

/* ====== EXPERIMENT STATE ====== */
const STARTING_CREDITS = 3000;
const BOX_PRICE = 600;
let participantID = null, age = "", sex = "", yearLevel = "", currentVideo = null;
let credits = STARTING_CREDITS, totalPurchased = 0, playbackStart = null;

/* ====== UI HELPERS ====== */
function generatePID(){
  const n = new Date();
  return "P" + n.getFullYear() + String(n.getMonth()+1).padStart(2,"0") + String(n.getDate()).padStart(2,"0")
    + "_" + String(n.getHours()).padStart(2,"0") + String(n.getMinutes()).padStart(2,"0") + String(n.getSeconds()).padStart(2,"0")
    + "_" + Math.floor(Math.random()*1000);
}
function updateStatus(){
  document.getElementById("status").innerText = `Credits Remaining: ₱${credits} · Blind Boxes Purchased: ${totalPurchased}`;
}

/* ====== FLOWS ====== */
function startExperiment(){
  age = (document.getElementById("ageInput").value || "").toString().trim();
  const radios = document.getElementsByName("sex");
  sex = [...radios].find(r=>r.checked)?.value || "";
  yearLevel = document.getElementById("yearInput").value || "";
  if(!age || !sex || !yearLevel){ alert("Fill Age, Sex, Year level"); return; }
  participantID = generatePID();
  document.getElementById("intro").style.display = "none";
  document.getElementById("experiment").style.display = "block";
  credits = STARTING_CREDITS; totalPurchased = 0; updateStatus();
  logEvent("FORM_SUBMIT",0,0,0);
}

/* loadVideo: set native video src and enable manual controls (scrubbing allowed) */
function loadVideo(num){
  currentVideo = num;
  // disable condition selection so participant stays in assigned video
  document.querySelectorAll('#videoButtons .btn').forEach(b=>{ b.disabled = true; b.classList.add('disabled'); });

  const v = document.getElementById("expVideo");
  v.pause();
  v.removeAttribute("src");
  v.load();

  // set source to direct-download stream URL (Drive must be public: Anyone with link → Viewer)
  v.src = driveDirect(DRIVE_IDS[num]);
  v.controls = true;         // enable controls for scrubbing & manual play
  v.muted = false;           // let them unmute if they want
  playbackStart = null;
  document.getElementById("buy-btn").style.display = "none"; // show buy only after actual play
  updateStatus();

  // attach event listeners
  v.removeEventListener("playing", onPlaying);
  v.removeEventListener("play", onPlay); // sometimes 'play' fires before actual media buffer
  v.removeEventListener("error", onError);

  v.addEventListener("playing", onPlaying);
  v.addEventListener("play", onPlay);
  v.addEventListener("error", onError);

  // ensure metadata is loaded so duration/currentTime available for scrubbing
  v.load();

  // log load to sheet
  logEvent("VIDEO_LOAD", 0, 0, 0);
}

/* when video actually starts playing (good signal) */
function onPlaying(){
  const v = document.getElementById("expVideo");
  if(!playbackStart) playbackStart = new Date();
  // show buy button so they can buy after watching
  document.getElementById("buy-btn").style.display = "inline-block";
  logEvent("VIDEO_PLAY", 0, 0, v.currentTime || 0);
}

/* 'play' event handler (helpful on some browsers) */
function onPlay(){
  // no-op here except to ensure listener attached
}

/* error */
function onError(e){
  console.warn("Video error", e);
  // fallback option: if Drive direct fails for some reason, we could optionally render a Drive preview iframe here.
  // For now we just log the error to the sheet so you can inspect.
  logEvent("VIDEO_ERROR", 0, 0, 0);
}

/* purchase */
function purchase(){
  const v = document.getElementById("expVideo");
  const playbackTime = (v && !isNaN(v.currentTime)) ? v.currentTime : 0;
  const elapsed = playbackStart ? ((new Date()) - playbackStart)/1000 : 0;

  if(credits >= BOX_PRICE){
    credits -= BOX_PRICE;
    totalPurchased++;
    updateStatus();
    logEvent("BUY", totalPurchased, elapsed, playbackTime);
  } else {
    alert("Not enough credits!");
  }
}

/* ====== LOGGING TO SHEETS (Apps Script POST) ====== */
function logEvent(action, purchases, elapsed, playbackTime){
  const payload = {
    timestamp: new Date().toISOString(),
    pid: participantID || "N/A",
    age: age || "N/A",
    sex: sex || "N/A",
    yearLevel: yearLevel || "N/A",
    videoNumber: currentVideo || "",
    videoFile: DRIVE_IDS[currentVideo] ? `drive:${DRIVE_IDS[currentVideo]}` : "",
    action: action,
    creditsRemaining: credits,
    totalPurchased: purchases,
    timeSinceStart: elapsed,
    videoPlaybackTime: playbackTime
  };
  const body = "data=" + encodeURIComponent(JSON.stringify(payload));
  fetch(GOOGLE_SCRIPT_URL, {
    method: "POST",
    headers: {"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},
    body
  })
  .then(r => r.text())
  .then(txt => console.log("Sheets response:", txt))
  .catch(err => console.error("Logging error:", err));
}

/* init */
credits = STARTING_CREDITS; totalPurchased = 0; updateStatus();
</script>
</body>
</html>
