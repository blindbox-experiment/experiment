<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TikTok Live Blind Box Experiment</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background: #fafafa;
      margin: 0;
      padding: 0;
    }
    .hidden { display: none; }
    .btn {
      display: inline-block;
      margin: 10px;
      padding: 12px 20px;
      border: none;
      border-radius: 6px;
      background: #333;
      color: white;
      cursor: pointer;
      font-size: 16px;
      transition: opacity 0.3s;
    }
    .btn:hover { background: #555; }
    .btn.disabled {
      background: #ccc;
      color: #666;
      cursor: not-allowed;
      opacity: 0.6;
    }
    video {
      width: 360px;
      height: 640px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      background: black;
    }
    #buy-btn {
      margin-top: 20px;
      background: #ff3b5c;
    }
    .video-container { display: flex; justify-content: center; margin-top: 20px; }
  </style>
</head>
<body>
  <h1>TikTok Live Blind Box Experiment</h1>

  <!-- AGE/GENDER FORM -->
  <div id="introForm">
    <h3>Before we begin, please enter your details:</h3>
    <label>Age: </label>
    <input type="number" id="ageInput" min="15" max="40" required><br><br>

    <label>Gender: </label>
    <label><input type="radio" name="gender" value="Male"> Male</label>
    <label><input type="radio" name="gender" value="Female"> Female</label><br><br>

    <button class="btn" onclick="startExperiment()">Continue</button>
  </div>

  <!-- VIDEO SELECTION -->
  <div id="experimentSection" class="hidden">
    <p>Select a video to start:</p>
    <div id="videoButtons">
      <button class="btn" onclick="loadVideo(1)">1st Video</button>
      <button class="btn" onclick="loadVideo(2)">2nd Video</button>
      <button class="btn" onclick="loadVideo(3)">3rd Video</button>
      <button class="btn" onclick="loadVideo(4)">4th Video</button>
    </div>

    <div class="video-container">
      <video id="expVideo" controls playsinline></video>
    </div>

    <div>
      <button id="buy-btn" class="btn hidden" onclick="purchase()">Buy Blind Box (₱600)</button>
    </div>

    <p id="credits"></p>
    <p id="purchases"></p>
  </div>

  <script>
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbytBcRUYGS9cXGciBkt7YSXPSR9LGWQwgR5gQacLKUR_i9HUyUNAFwaso028hzlKt8kBA/exec";

    const VIDEOS = {
      1: "videos/video1.mp4", // Control
      2: "videos/video2.mp4", // Scarcity only
      3: "videos/video3.mp4", // Social proof only
      4: "videos/video4.mp4"  // Both cues
    };

    const STARTING_CREDITS = 3000;
    const BOX_PRICE = 600;

    let participantID, currentVideo, credits, totalPurchased, videoStartTime, age, gender;

    function generatePID() {
      const now = new Date();
      return "P" + now.getFullYear() + 
        (now.getMonth()+1).toString().padStart(2,'0') + 
        now.getDate().toString().padStart(2,'0') + "_" + 
        now.getHours().toString().padStart(2,'0') + 
        now.getMinutes().toString().padStart(2,'0') + 
        now.getSeconds().toString().padStart(2,'0') + "_" + 
        Math.floor(Math.random()*1000);
    }

    function startExperiment() {
      age = document.getElementById("ageInput").value;
      const genderRadios = document.getElementsByName("gender");
      gender = [...genderRadios].find(r => r.checked)?.value || "";

      if (!age || !gender) {
        alert("Please enter both Age and Gender.");
        return;
      }

      document.getElementById("introForm").classList.add("hidden");
      document.getElementById("experimentSection").classList.remove("hidden");

      participantID = generatePID();
      logEvent("FORM_SUBMIT", 0, 0);
    }

    function loadVideo(num) {
      currentVideo = {number: num, file: VIDEOS[num]};

      const buttons = document.querySelectorAll('#videoButtons .btn');
      buttons.forEach(btn => {
        btn.classList.add('disabled');
        btn.disabled = true;
      });

      const videoEl = document.getElementById("expVideo");
      videoEl.src = currentVideo.file;
      document.getElementById("buy-btn").classList.remove("hidden");

      credits = STARTING_CREDITS;
      totalPurchased = 0;
      videoStartTime = null;
      updateStatus();

      logEvent("VIDEO_LOAD", 0, 0);

      videoEl.addEventListener("play", () => {
        if (!videoStartTime) {
          videoStartTime = new Date();
          logEvent("VIDEO_PLAY", 0, 0);
        }
      });
    }

    function purchase() {
      if (credits >= BOX_PRICE) {
        credits -= BOX_PRICE;
        totalPurchased++;
        updateStatus();

        let elapsed = 0;
        if (videoStartTime) elapsed = (new Date() - videoStartTime) / 1000;
        logEvent("BUY", totalPurchased, elapsed);
      } else {
        alert("Not enough credits!");
      }
    }

    function updateStatus() {
      document.getElementById("credits").innerText = "Credits Remaining: ₱" + credits;
      document.getElementById("purchases").innerText = "Blind Boxes Purchased: " + totalPurchased;
    }

    function logEvent(action, purchases, elapsedTime) {
      const payload = {
        timestamp: new Date().toISOString(),
        pid: participantID,
        age: age,
        gender: gender,
        videoNumber: currentVideo ? currentVideo.number : "",
        videoFile: currentVideo ? currentVideo.file : "",
        action: action,
        creditsRemaining: credits,
        totalPurchased: purchases,
        timeSinceStart: elapsedTime
      };

      const body = "data=" + encodeURIComponent(JSON.stringify(payload));
      fetch(GOOGLE_SCRIPT_URL, {
        method: "POST",
        headers: {"Content-Type": "application/x-www-form-urlencoded;charset=UTF-8"},
        body
      })
      .then(r => r.text())
      .then(txt => console.log("Sheets response:", txt))
      .catch(err => console.error("Logging error", err));
    }
  </script>
</body>
</html>
